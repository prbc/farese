<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script defer="" src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
  <link rel="stylesheet" href="/css/additional.css">
  <link rel="stylesheet" href="/css/farese.css">
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.2.0/mapbox-gl.js"></script>
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.2.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.1/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.1/mapbox-gl-geocoder.css" type="text/css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <!-- Header bar theme -->
  <meta name="theme-color" content="#00538f">
  <!-- Android Chrome header color -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <!-- Fullscreen mode for iOS Safari -->
  <meta name="apple-mobile-web-app-status-bar-style" content="#00538f">
  <!-- iOS Safari header color -->
  <meta name="msapplication-navbutton-color" content="#00538f">
  <!-- Windows phone header color -->
</head>

<body>
  <nav class="navbar navbar-expand-md bg-primary navbar-dark border border-primary position-static">
    <div class="container">
      <a class="navbar-brand" href="/">Farese.com</a>
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbar2SupportedContent" aria-controls="navbar2SupportedContent" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button>
      <div class="collapse navbar-collapse text-center justify-content-end" id="navbar2SupportedContent">
        <ul class="navbar-nav ml-auto text-light">
          <li class="nav-item text-center">
            <a class="nav-link" href="/">Home</a>
          </li>
          <li class="nav-item text-center">
            <a class="nav-link" href="/about/">About</a>
          </li>
          <li class="nav-item text-center">
            <a class="nav-link" href="/map/">Map</a>
          </li>
          <li class="nav-item text-center">
            <a class="nav-link" href="/list/">List</a>
          </li>
          <li class="nav-item text-center">
            <a class="nav-link" href="/legacy/">Legacy</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="position-fixed" id="map"></div>
  <script>
    var isDataLoaded = false;
    var isStyleLoaded = false;
    var markers;

    mapboxgl.accessToken = 'pk.eyJ1IjoibGFpbiIsImEiOiJjaWhzbHBpMXMwMHNldGdtMWgxbGp4aWRoIn0.BE_Fxskfnqumxa_5FLBWcA';

    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v9',
        center: [0,0],
        zoom: .7,
        hash: true,
    });

    var loadMap = function () {
       // Add marker data as a new GeoJSON source.
       map.addSource("markers", {
          "type": "geojson",
          "data": markers
       });

        // Load image for pin
        map.loadImage('/img/marker.png', function(error, image) {
            if (error) throw error;
            map.addImage('pin', image);
            // Add a layer showing the markers.
            map.addLayer({
                "id": "markers",
                "interactive": true,
                "type": "symbol",
                "source": "markers",
                "layout": {
                    "icon-image": "pin",
                    "icon-size": .6,
                    "icon-allow-overlap": true,
                }
            });
        });

       // When a click event occurs near a marker icon, open a popup at the location of
       // the feature, with description HTML from its properties.
       map.on('click', function (e) {
           var bboxSize = 25;
           var bbox = [[e.point.x - bboxSize, e.point.y - bboxSize], [e.point.x + bboxSize, e.point.y + bboxSize]];
           var features = map.queryRenderedFeatures(bbox, { layers: ['markers'] });

           if (!features.length) {
               return;
           }

           var feature = features[0];

           // Populate the popup and set its coordinates
           // based on the feature found.
           var popup = new mapboxgl.Popup()
              .setLngLat(feature.geometry.coordinates)
              // Should look like:
              // <h4>Church Name</h4>
              // Address (links to a corresponding http://maps.apple.com/?q=51.507269,-0.127695 to open maps externally)
              // Website (links to the appropriate url)
              // Note 
		       .setHTML('<h4>'+feature.properties.name+'</h4>'  + '<div id="address"><a href="http://maps.apple.com/?q=' + feature.geometry.coordinates[1] + ',' + feature.geometry.coordinates[0] + '">' + feature.properties.address + '</a></div>' + '<div id="website"><a href="'+feature.properties.website+'">'+feature.properties.website+'</a></div>' + '<p>' + feature.properties.note + '</p>')
              .addTo(map);

           // Pan to clicked marker
           if (features.length) {
              // Get coordinates from the symbol and center the map on those coordinates
              map.flyTo({
                 center: features[0].geometry.coordinates,
                 speed: 0.3
              });
           }
       });

       // Use the same approach as above to indicate that the symbols are clickable
       // by changing the cursor style to 'pointer'.
       map.on('mousemove', function (e) {
          var features = map.queryRenderedFeatures(e.point, { layers: ['markers'] });
          map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
       });
    }

    // disable map rotation using right click + drag
    map.dragRotate.disable();

    // disable map rotation using touch rotation gesture
    map.touchZoomRotate.disableRotation();

    // Add zoom and rotation controls to the map.
    map.addControl(new mapboxgl.NavigationControl, 'top-left');

    function forwardGeocoder(query) {
        var matchingFeatures = [];
        for (var i = 0; i < markers.features.length; i++) {
            var feature = markers.features[i];
            // handle queries with different capitalization than the source data by calling toLowerCase()
            if (feature.properties.name.toLowerCase().search(query.toLowerCase()) !== -1) {
                // add a church emoji as a prefix for custom data results
                feature['place_name'] = 'â›ª ' + feature.properties.name;
                feature['center'] = feature.geometry.coordinates;
                //feature['place_type'] = ['park'];
                matchingFeatures.push(feature);
            }
        }
        return matchingFeatures;
    }

    // Add geocoder
    map.addControl(new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
	localGeocoder: forwardGeocoder,
        placeholder: "Search by location or church",
        limit: 5,
    }));

    // Add geolocate control 
    map.addControl(new mapboxgl.GeolocateControl({
        positionOptions: {
            enableHighAccuracy: true
        },
        fitBoundsOptions: {
            maxZoom:8
        },
        trackUserLocation: true
    }), 'top-left');

    // Load GeoJSON data

    var shouldLoadMap = function () {
       return isDataLoaded && isStyleLoaded
    }

    jQuery.getJSON("data.json", function(json) {
          markers = json;
          isDataLoaded = true;
          if (shouldLoadMap()) {
             loadMap()
          }
    })

    map.on('style.load', function () {
       isStyleLoaded = true;
       if (shouldLoadMap()) {
          loadMap()
       }
    });
  </script>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" crossorigin="anonymous" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" crossorigin="anonymous" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" crossorigin="anonymous" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"></script>
</body>

</html>
